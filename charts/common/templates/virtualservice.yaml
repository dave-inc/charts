{{- if .Values.canary.enabled -}}
{{- $canaryWeight := .Values.canary.weight | default 5 }}
{{- $effectiveCanaryWeight := min (max $canaryWeight 0) 100 }}
{{- $remainingWeight := sub 100 $effectiveCanaryWeight }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: {{ include "common.name" . }}-mesh
spec:
  hosts:
  - {{ .Values.service.name | default (include "common.name" .) }}
  http:
  - route:
    - destination:
        host: {{ .Values.service.name | default (include "common.name" .) }}
        subset: canary
      weight: {{ $effectiveCanaryWeight }}
    - destination:
        host: {{ .Values.service.name | default (include "common.name" .) }}
        subset: production
      weight: {{ $remainingWeight }}
{{- end }}
